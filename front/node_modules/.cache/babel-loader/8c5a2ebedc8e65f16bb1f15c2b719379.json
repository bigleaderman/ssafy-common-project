{"ast":null,"code":"\"use strict\";\n/*\n * (C) Copyright 2017-2022 OpenVidu (https://openvidu.io)\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n *\n */\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.OpenVidu = void 0;\n\nvar LocalRecorder_1 = require(\"./LocalRecorder\");\n\nvar Publisher_1 = require(\"./Publisher\");\n\nvar Session_1 = require(\"./Session\");\n\nvar SessionDisconnectedEvent_1 = require(\"../OpenViduInternal/Events/SessionDisconnectedEvent\");\n\nvar StreamPropertyChangedEvent_1 = require(\"../OpenViduInternal/Events/StreamPropertyChangedEvent\");\n\nvar OpenViduError_1 = require(\"../OpenViduInternal/Enums/OpenViduError\");\n\nvar VideoInsertMode_1 = require(\"../OpenViduInternal/Enums/VideoInsertMode\");\n\nvar OpenViduLogger_1 = require(\"../OpenViduInternal/Logger/OpenViduLogger\");\n\nvar Platform_1 = require(\"../OpenViduInternal/Utils/Platform\");\n\nvar screenSharingAuto = require(\"../OpenViduInternal/ScreenSharing/Screen-Capturing-Auto\");\n\nvar screenSharing = require(\"../OpenViduInternal/ScreenSharing/Screen-Capturing\");\n\nvar OpenViduLoggerConfiguration_1 = require(\"../OpenViduInternal/Logger/OpenViduLoggerConfiguration\");\n/**\n * @hidden\n */\n\n\nvar EventEmitter = require(\"wolfy87-eventemitter\");\n/**\n * @hidden\n */\n\n\nvar RpcBuilder = require(\"../OpenViduInternal/KurentoUtils/kurento-jsonrpc\");\n/**\n * @hidden\n */\n\n\nvar packageJson = require('../../package.json');\n/**\n * @hidden\n */\n\n\nvar logger = OpenViduLogger_1.OpenViduLogger.getInstance();\n/**\n * @hidden\n */\n\nvar platform;\n/**\n * Entrypoint of OpenVidu Browser library.\n * Use it to initialize objects of type [[Session]], [[Publisher]] and [[LocalRecorder]]\n */\n\nvar OpenVidu =\n/** @class */\nfunction () {\n  function OpenVidu() {\n    var _this = this;\n\n    this.masterNodeHasCrashed = false;\n    /**\n     * @hidden\n     */\n\n    this.publishers = [];\n    /**\n     * @hidden\n     */\n\n    this.secret = '';\n    /**\n     * @hidden\n     */\n\n    this.recorder = false;\n    /**\n     * @hidden\n     */\n\n    this.life = -1;\n    /**\n     * @hidden\n     */\n\n    this.advancedConfiguration = {};\n    /**\n     * @hidden\n     */\n\n    this.webrtcStatsInterval = -1;\n    /**\n     * @hidden\n     */\n\n    this.sendBrowserLogs = OpenViduLoggerConfiguration_1.OpenViduLoggerConfiguration.disabled;\n    /**\n     * @hidden\n     */\n\n    this.isAtLeastPro = false;\n    /**\n     * @hidden\n     */\n\n    this.isEnterprise = false;\n    /**\n     * @hidden\n     */\n\n    this.ee = new EventEmitter();\n    platform = Platform_1.PlatformUtils.getInstance();\n    this.libraryVersion = packageJson.version;\n    logger.info(\"OpenVidu initialized\");\n    logger.info('Platform detected: ' + platform.getDescription());\n    logger.info('openvidu-browser version: ' + this.libraryVersion);\n\n    if (platform.isMobileDevice() || platform.isReactNative()) {\n      // Listen to orientationchange only on mobile devices\n      this.onOrientationChanged(function () {\n        _this.publishers.forEach(function (publisher) {\n          if (publisher.stream.isLocalStreamPublished && !!publisher.stream && !!publisher.stream.hasVideo) {\n            _this.sendNewVideoDimensionsIfRequired(publisher, 'deviceRotated', 75, 10);\n          }\n        });\n      });\n    }\n  }\n  /**\n   * Returns new session\n   */\n\n\n  OpenVidu.prototype.initSession = function () {\n    this.session = new Session_1.Session(this);\n    return this.session;\n  };\n  /**\n   * Returns a new publisher\n   *\n   * #### Events dispatched\n   *\n   * The [[Publisher]] object will dispatch an `accessDialogOpened` event, only if the pop-up shown by the browser to request permissions for the camera is opened. You can use this event to alert the user about granting permissions\n   * for your website. An `accessDialogClosed` event will also be dispatched after user clicks on \"Allow\" or \"Block\" in the pop-up.\n   *\n   * The [[Publisher]] object will dispatch an `accessAllowed` or `accessDenied` event once it has been granted access to the requested input devices or not.\n   *\n   * The [[Publisher]] object will dispatch a `videoElementCreated` event once a HTML video element has been added to DOM (only if you\n   * [let OpenVidu take care of the video players](/en/stable/cheatsheet/manage-videos/#let-openvidu-take-care-of-the-video-players)). See [[VideoElementEvent]] to learn more.\n   *\n   * The [[Publisher]] object will dispatch a `streamPlaying` event once the local streams starts playing. See [[StreamManagerEvent]] to learn more.\n   *\n   * @param targetElement  HTML DOM element (or its `id` attribute) in which the video element of the Publisher will be inserted (see [[PublisherProperties.insertMode]]). If *null* or *undefined* no default video will be created for this Publisher.\n   * You can always call method [[Publisher.addVideoElement]] or [[Publisher.createVideoElement]] to manage the video elements on your own (see [Manage video players](/en/stable/cheatsheet/manage-videos) section)\n   * @param completionHandler `error` parameter is null if `initPublisher` succeeds, and is defined if it fails.\n   *                          `completionHandler` function is called before the Publisher dispatches an `accessAllowed` or an `accessDenied` event\n   */\n\n\n  OpenVidu.prototype.initPublisher = function (targetElement, param2, param3) {\n    var properties;\n\n    if (!!param2 && typeof param2 !== 'function') {\n      // Matches 'initPublisher(targetElement, properties)' or 'initPublisher(targetElement, properties, completionHandler)'\n      properties = param2;\n      properties = {\n        audioSource: typeof properties.audioSource !== 'undefined' ? properties.audioSource : undefined,\n        frameRate: typeof MediaStreamTrack !== 'undefined' && properties.videoSource instanceof MediaStreamTrack ? undefined : typeof properties.frameRate !== 'undefined' ? properties.frameRate : undefined,\n        insertMode: typeof properties.insertMode !== 'undefined' ? typeof properties.insertMode === 'string' ? VideoInsertMode_1.VideoInsertMode[properties.insertMode] : properties.insertMode : VideoInsertMode_1.VideoInsertMode.APPEND,\n        mirror: typeof properties.mirror !== 'undefined' ? properties.mirror : true,\n        publishAudio: typeof properties.publishAudio !== 'undefined' ? properties.publishAudio : true,\n        publishVideo: typeof properties.publishVideo !== 'undefined' ? properties.publishVideo : true,\n        resolution: typeof MediaStreamTrack !== 'undefined' && properties.videoSource instanceof MediaStreamTrack ? undefined : typeof properties.resolution !== 'undefined' ? properties.resolution : '640x480',\n        videoSource: typeof properties.videoSource !== 'undefined' ? properties.videoSource : undefined,\n        videoSimulcast: properties.videoSimulcast,\n        filter: properties.filter\n      };\n    } else {\n      // Matches 'initPublisher(targetElement)' or 'initPublisher(targetElement, completionHandler)'\n      properties = {\n        insertMode: VideoInsertMode_1.VideoInsertMode.APPEND,\n        mirror: true,\n        publishAudio: true,\n        publishVideo: true,\n        resolution: '640x480'\n      };\n    }\n\n    var publisher = new Publisher_1.Publisher(targetElement, properties, this);\n    var completionHandler;\n\n    if (!!param2 && typeof param2 === 'function') {\n      completionHandler = param2;\n    } else if (!!param3) {\n      completionHandler = param3;\n    }\n\n    publisher.initialize().then(function () {\n      if (completionHandler !== undefined) {\n        completionHandler(undefined);\n      }\n\n      publisher.emitEvent('accessAllowed', []);\n    }).catch(function (error) {\n      if (completionHandler !== undefined) {\n        completionHandler(error);\n      }\n\n      publisher.emitEvent('accessDenied', [error]);\n    });\n    this.publishers.push(publisher);\n    return publisher;\n  };\n\n  OpenVidu.prototype.initPublisherAsync = function (targetElement, properties) {\n    var _this = this;\n\n    return new Promise(function (resolve, reject) {\n      var publisher;\n\n      var callback = function (error) {\n        if (!!error) {\n          return reject(error);\n        } else {\n          return resolve(publisher);\n        }\n      };\n\n      if (!!properties) {\n        publisher = _this.initPublisher(targetElement, properties, callback);\n      } else {\n        publisher = _this.initPublisher(targetElement, callback);\n      }\n    });\n  };\n  /**\n   * Returns a new local recorder for recording streams straight away from the browser\n   * @param stream  Stream to record\n   */\n\n\n  OpenVidu.prototype.initLocalRecorder = function (stream) {\n    return new LocalRecorder_1.LocalRecorder(stream);\n  };\n  /**\n   * Checks if the browser supports OpenVidu\n   * @returns 1 if the browser supports OpenVidu, 0 otherwise\n   */\n\n\n  OpenVidu.prototype.checkSystemRequirements = function () {\n    if (platform.isIPhoneOrIPad()) {\n      if (platform.isIOSWithSafari() || platform.isIonicIos() || platform.isChromeMobileBrowser() || platform.isEdgeMobileBrowser() || platform.isOperaMobileBrowser() || platform.isFirefoxMobileBrowser()) {\n        return 1;\n      }\n\n      return 0;\n    } // Accept: Chrome (desktop and Android), Firefox (desktop and Android), Opera (desktop and Android),\n    // Safari (OSX and iOS), Edge Chromium (>= 80), Ionic (Android and iOS), Samsung Internet Browser (Android)\n\n\n    if (platform.isChromeBrowser() || platform.isChromeMobileBrowser() || platform.isFirefoxBrowser() || platform.isFirefoxMobileBrowser() || platform.isOperaBrowser() || platform.isOperaMobileBrowser() || platform.isEdgeBrowser() || platform.isEdgeMobileBrowser() || platform.isSafariBrowser() || platform.isAndroidBrowser() || platform.isElectron() || platform.isSamsungBrowser()) {\n      return 1;\n    } // Reject iPhones and iPads if not Safari ('Safari' also covers Ionic for iOS)\n    // Reject others browsers not mentioned above\n\n\n    return 0;\n  };\n  /**\n   * Checks if the browser supports screen-sharing. Desktop Chrome, Firefox and Opera support screen-sharing\n   * @returns 1 if the browser supports screen-sharing, 0 otherwise\n   */\n\n\n  OpenVidu.prototype.checkScreenSharingCapabilities = function () {\n    return platform.canScreenShare();\n  };\n  /**\n   * Collects information about the media input devices available on the system. You can pass property `deviceId` of a [[Device]] object as value of `audioSource` or `videoSource` properties in [[initPublisher]] method\n   */\n\n\n  OpenVidu.prototype.getDevices = function () {\n    return new Promise(function (resolve, reject) {\n      navigator.mediaDevices.enumerateDevices().then(function (deviceInfos) {\n        var _a;\n\n        var devices = []; // Ionic Android  devices\n\n        if (platform.isIonicAndroid() && typeof cordova != \"undefined\" && ((_a = cordova === null || cordova === void 0 ? void 0 : cordova.plugins) === null || _a === void 0 ? void 0 : _a.EnumerateDevicesPlugin)) {\n          cordova.plugins.EnumerateDevicesPlugin.getEnumerateDevices().then(function (pluginDevices) {\n            var pluginAudioDevices = [];\n            var videoDevices = [];\n            var audioDevices = [];\n            pluginAudioDevices = pluginDevices.filter(function (device) {\n              return device.kind === 'audioinput';\n            });\n            videoDevices = deviceInfos.filter(function (device) {\n              return device.kind === 'videoinput';\n            });\n            audioDevices = deviceInfos.filter(function (device) {\n              return device.kind === 'audioinput';\n            });\n            videoDevices.forEach(function (deviceInfo, index) {\n              if (!deviceInfo.label) {\n                var label = \"\";\n\n                if (index === 0) {\n                  label = \"Front Camera\";\n                } else if (index === 1) {\n                  label = \"Back Camera\";\n                } else {\n                  label = \"Unknown Camera\";\n                }\n\n                devices.push({\n                  kind: deviceInfo.kind,\n                  deviceId: deviceInfo.deviceId,\n                  label: label\n                });\n              } else {\n                devices.push({\n                  kind: deviceInfo.kind,\n                  deviceId: deviceInfo.deviceId,\n                  label: deviceInfo.label\n                });\n              }\n            });\n            audioDevices.forEach(function (deviceInfo, index) {\n              if (!deviceInfo.label) {\n                var label = \"\";\n\n                switch (index) {\n                  case 0:\n                    // Default Microphone\n                    label = 'Default';\n                    break;\n\n                  case 1:\n                    // Microphone + Speakerphone\n                    var defaultMatch = pluginAudioDevices.filter(function (d) {\n                      return d.label.includes('Built');\n                    })[0];\n                    label = defaultMatch ? defaultMatch.label : 'Built-in Microphone';\n                    break;\n\n                  case 2:\n                    // Headset Microphone\n                    var wiredMatch = pluginAudioDevices.filter(function (d) {\n                      return d.label.includes('Wired');\n                    })[0];\n\n                    if (wiredMatch) {\n                      label = wiredMatch.label;\n                    } else {\n                      label = 'Headset earpiece';\n                    }\n\n                    break;\n\n                  case 3:\n                    var wirelessMatch = pluginAudioDevices.filter(function (d) {\n                      return d.label.includes('Bluetooth');\n                    })[0];\n                    label = wirelessMatch ? wirelessMatch.label : 'Wireless';\n                    break;\n\n                  default:\n                    label = \"Unknown Microphone\";\n                    break;\n                }\n\n                devices.push({\n                  kind: deviceInfo.kind,\n                  deviceId: deviceInfo.deviceId,\n                  label: label\n                });\n              } else {\n                devices.push({\n                  kind: deviceInfo.kind,\n                  deviceId: deviceInfo.deviceId,\n                  label: deviceInfo.label\n                });\n              }\n            });\n            return resolve(devices);\n          });\n        } else {\n          // Rest of platforms\n          deviceInfos.forEach(function (deviceInfo) {\n            if (deviceInfo.kind === 'audioinput' || deviceInfo.kind === 'videoinput') {\n              devices.push({\n                kind: deviceInfo.kind,\n                deviceId: deviceInfo.deviceId,\n                label: deviceInfo.label\n              });\n            }\n          });\n          return resolve(devices);\n        }\n      }).catch(function (error) {\n        logger.error('Error getting devices', error);\n        return reject(error);\n      });\n    });\n  };\n  /**\n   * Get a MediaStream object that you can customize before calling [[initPublisher]] (pass _MediaStreamTrack_ property of the _MediaStream_ value resolved by the Promise as `audioSource` or `videoSource` properties in [[initPublisher]])\n   *\n   * Parameter `options` is the same as in [[initPublisher]] second parameter (of type [[PublisherProperties]]), but only the following properties will be applied: `audioSource`, `videoSource`, `frameRate`, `resolution`\n   *\n   * To customize the Publisher's video, the API for HTMLCanvasElement is very useful. For example, to get a black-and-white video at 10 fps and HD resolution with no sound:\n   * ```\n   * var OV = new OpenVidu();\n   * var FRAME_RATE = 10;\n   *\n   * OV.getUserMedia({\n   *    audioSource: false,\n   *    videoSource: undefined,\n   *    resolution: '1280x720',\n   *    frameRate: FRAME_RATE\n   * })\n   * .then(mediaStream => {\n   *\n   *    var videoTrack = mediaStream.getVideoTracks()[0];\n   *    var video = document.createElement('video');\n   *    video.srcObject = new MediaStream([videoTrack]);\n   *\n   *    var canvas = document.createElement('canvas');\n   *    var ctx = canvas.getContext('2d');\n   *    ctx.filter = 'grayscale(100%)';\n   *\n   *    video.addEventListener('play', () => {\n   *      var loop = () => {\n   *        if (!video.paused && !video.ended) {\n   *          ctx.drawImage(video, 0, 0, 300, 170);\n   *          setTimeout(loop, 1000/ FRAME_RATE); // Drawing at 10 fps\n   *        }\n   *      };\n   *      loop();\n   *    });\n   *    video.play();\n   *\n   *    var grayVideoTrack = canvas.captureStream(FRAME_RATE).getVideoTracks()[0];\n   *    var publisher = this.OV.initPublisher(\n   *      myHtmlTarget,\n   *      {\n   *        audioSource: false,\n   *        videoSource: grayVideoTrack\n   *      });\n   * });\n   * ```\n   */\n\n\n  OpenVidu.prototype.getUserMedia = function (options) {\n    var _this = this;\n\n    return new Promise(function (resolve, reject) {\n      var askForAudioStreamOnly = function (previousMediaStream, constraints) {\n        var definedAudioConstraint = constraints.audio === undefined ? true : constraints.audio;\n        var constraintsAux = {\n          audio: definedAudioConstraint,\n          video: false\n        };\n        navigator.mediaDevices.getUserMedia(constraintsAux).then(function (audioOnlyStream) {\n          previousMediaStream.addTrack(audioOnlyStream.getAudioTracks()[0]);\n          return resolve(previousMediaStream);\n        }).catch(function (error) {\n          previousMediaStream.getAudioTracks().forEach(function (track) {\n            track.stop();\n          });\n          previousMediaStream.getVideoTracks().forEach(function (track) {\n            track.stop();\n          });\n          return reject(_this.generateAudioDeviceError(error, constraintsAux));\n        });\n      };\n\n      _this.generateMediaConstraints(options).then(function (myConstraints) {\n        var _a, _b;\n\n        if (!!myConstraints.videoTrack && !!myConstraints.audioTrack || !!myConstraints.audioTrack && ((_a = myConstraints.constraints) === null || _a === void 0 ? void 0 : _a.video) === false || !!myConstraints.videoTrack && ((_b = myConstraints.constraints) === null || _b === void 0 ? void 0 : _b.audio) === false) {\n          // No need to call getUserMedia at all. Both tracks provided, or only AUDIO track provided or only VIDEO track provided\n          return resolve(_this.addAlreadyProvidedTracks(myConstraints, new MediaStream()));\n        } else {\n          // getUserMedia must be called. AUDIO or VIDEO are requesting a new track\n          // Delete already provided constraints for audio or video\n          if (!!myConstraints.videoTrack) {\n            delete myConstraints.constraints.video;\n          }\n\n          if (!!myConstraints.audioTrack) {\n            delete myConstraints.constraints.audio;\n          }\n\n          var mustAskForAudioTrackLater_1 = false;\n\n          if (typeof options.videoSource === 'string') {\n            // Video is deviceId or screen sharing\n            if (options.videoSource === 'screen' || options.videoSource === 'window' || platform.isElectron() && options.videoSource.startsWith('screen:')) {\n              // Video is screen sharing\n              mustAskForAudioTrackLater_1 = !myConstraints.audioTrack && options.audioSource !== null && options.audioSource !== false;\n\n              if (navigator.mediaDevices['getDisplayMedia'] && !platform.isElectron()) {\n                // getDisplayMedia supported\n                navigator.mediaDevices['getDisplayMedia']({\n                  video: true\n                }).then(function (mediaStream) {\n                  _this.addAlreadyProvidedTracks(myConstraints, mediaStream);\n\n                  if (mustAskForAudioTrackLater_1) {\n                    askForAudioStreamOnly(mediaStream, myConstraints.constraints);\n                    return;\n                  } else {\n                    return resolve(mediaStream);\n                  }\n                }).catch(function (error) {\n                  var errorName = OpenViduError_1.OpenViduErrorName.SCREEN_CAPTURE_DENIED;\n                  var errorMessage = error.toString();\n                  return reject(new OpenViduError_1.OpenViduError(errorName, errorMessage));\n                });\n                return;\n              } else {// getDisplayMedia NOT supported. Can perform getUserMedia below with already calculated constraints\n              }\n            } else {// Video is deviceId. Can perform getUserMedia below with already calculated constraints\n            }\n          } // Use already calculated constraints\n\n\n          var constraintsAux = mustAskForAudioTrackLater_1 ? {\n            video: myConstraints.constraints.video\n          } : myConstraints.constraints;\n          navigator.mediaDevices.getUserMedia(constraintsAux).then(function (mediaStream) {\n            _this.addAlreadyProvidedTracks(myConstraints, mediaStream);\n\n            if (mustAskForAudioTrackLater_1) {\n              askForAudioStreamOnly(mediaStream, myConstraints.constraints);\n              return;\n            } else {\n              return resolve(mediaStream);\n            }\n          }).catch(function (error) {\n            var errorName;\n            var errorMessage = error.toString();\n\n            if (!(options.videoSource === 'screen')) {\n              errorName = OpenViduError_1.OpenViduErrorName.DEVICE_ACCESS_DENIED;\n            } else {\n              errorName = OpenViduError_1.OpenViduErrorName.SCREEN_CAPTURE_DENIED;\n            }\n\n            return reject(new OpenViduError_1.OpenViduError(errorName, errorMessage));\n          });\n        }\n      }).catch(function (error) {\n        return reject(error);\n      });\n    });\n  };\n  /* tslint:disable:no-empty */\n\n  /**\n   * Disable all logging except error level\n   */\n\n\n  OpenVidu.prototype.enableProdMode = function () {\n    logger.enableProdMode();\n  };\n  /* tslint:enable:no-empty */\n\n  /**\n   * Set OpenVidu advanced configuration options. `configuration` is an object of type [[OpenViduAdvancedConfiguration]]. Call this method to override previous values at any moment.\n   */\n\n\n  OpenVidu.prototype.setAdvancedConfiguration = function (configuration) {\n    this.advancedConfiguration = configuration;\n  };\n  /* Hidden methods */\n\n  /**\n   * @hidden\n   */\n\n\n  OpenVidu.prototype.onOrientationChanged = function (handler) {\n    window.addEventListener('orientationchange', handler);\n  };\n  /**\n   * @hidden\n   */\n\n\n  OpenVidu.prototype.sendNewVideoDimensionsIfRequired = function (publisher, reason, WAIT_INTERVAL, MAX_ATTEMPTS) {\n    var _this = this;\n\n    var attempts = 0;\n    var oldWidth = publisher.stream.videoDimensions.width;\n    var oldHeight = publisher.stream.videoDimensions.height;\n    var repeatUntilChangeOrMaxAttempts = setInterval(function () {\n      attempts++;\n\n      if (attempts > MAX_ATTEMPTS) {\n        clearTimeout(repeatUntilChangeOrMaxAttempts);\n      }\n\n      publisher.getVideoDimensions().then(function (newDimensions) {\n        if (newDimensions.width !== oldWidth || newDimensions.height !== oldHeight) {\n          clearTimeout(repeatUntilChangeOrMaxAttempts);\n\n          _this.sendVideoDimensionsChangedEvent(publisher, reason, oldWidth, oldHeight, newDimensions.width, newDimensions.height);\n        }\n      });\n    }, WAIT_INTERVAL);\n  };\n  /**\n   * @hidden\n   */\n\n\n  OpenVidu.prototype.sendVideoDimensionsChangedEvent = function (publisher, reason, oldWidth, oldHeight, newWidth, newHeight) {\n    var _this = this;\n\n    publisher.stream.videoDimensions = {\n      width: newWidth || 0,\n      height: newHeight || 0\n    };\n    this.sendRequest('streamPropertyChanged', {\n      streamId: publisher.stream.streamId,\n      property: 'videoDimensions',\n      newValue: JSON.stringify(publisher.stream.videoDimensions),\n      reason: reason\n    }, function (error, response) {\n      if (error) {\n        logger.error(\"Error sending 'streamPropertyChanged' event\", error);\n      } else {\n        _this.session.emitEvent('streamPropertyChanged', [new StreamPropertyChangedEvent_1.StreamPropertyChangedEvent(_this.session, publisher.stream, 'videoDimensions', publisher.stream.videoDimensions, {\n          width: oldWidth,\n          height: oldHeight\n        }, reason)]);\n\n        publisher.emitEvent('streamPropertyChanged', [new StreamPropertyChangedEvent_1.StreamPropertyChangedEvent(publisher, publisher.stream, 'videoDimensions', publisher.stream.videoDimensions, {\n          width: oldWidth,\n          height: oldHeight\n        }, reason)]);\n\n        _this.session.sendVideoData(publisher);\n      }\n    });\n  };\n\n  ;\n  /**\n   * @hidden\n   */\n\n  OpenVidu.prototype.generateMediaConstraints = function (publisherProperties) {\n    var _this = this;\n\n    return new Promise(function (resolve, reject) {\n      var myConstraints = {\n        audioTrack: undefined,\n        videoTrack: undefined,\n        constraints: {\n          audio: undefined,\n          video: undefined\n        }\n      };\n      var audioSource = publisherProperties.audioSource;\n      var videoSource = publisherProperties.videoSource; // CASE 1: null/false\n\n      if (audioSource === null || audioSource === false) {\n        // No audio track\n        myConstraints.constraints.audio = false;\n      }\n\n      if (videoSource === null || videoSource === false) {\n        // No video track\n        myConstraints.constraints.video = false;\n      }\n\n      if (myConstraints.constraints.audio === false && myConstraints.constraints.video === false) {\n        // ERROR! audioSource and videoSource cannot be both false at the same time\n        return reject(new OpenViduError_1.OpenViduError(OpenViduError_1.OpenViduErrorName.NO_INPUT_SOURCE_SET, \"Properties 'audioSource' and 'videoSource' cannot be set to false or null at the same time\"));\n      } // CASE 2: MediaStreamTracks\n\n\n      if (typeof MediaStreamTrack !== 'undefined' && audioSource instanceof MediaStreamTrack) {\n        // Already provided audio track\n        myConstraints.audioTrack = audioSource;\n      }\n\n      if (typeof MediaStreamTrack !== 'undefined' && videoSource instanceof MediaStreamTrack) {\n        // Already provided video track\n        myConstraints.videoTrack = videoSource;\n      } // CASE 3: Default tracks\n\n\n      if (audioSource === undefined) {\n        myConstraints.constraints.audio = true;\n      }\n\n      if (videoSource === undefined) {\n        myConstraints.constraints.video = {\n          width: {\n            ideal: 640\n          },\n          height: {\n            ideal: 480\n          }\n        };\n      } // CASE 3.5: give values to resolution and frameRate if video not null/false\n\n\n      if (videoSource !== null && videoSource !== false) {\n        if (!!publisherProperties.resolution) {\n          var widthAndHeight = publisherProperties.resolution.toLowerCase().split('x');\n          var idealWidth = Number(widthAndHeight[0]);\n          var idealHeight = Number(widthAndHeight[1]);\n          myConstraints.constraints.video = {\n            width: {\n              ideal: idealWidth\n            },\n            height: {\n              ideal: idealHeight\n            }\n          };\n        }\n\n        if (!!publisherProperties.frameRate) {\n          myConstraints.constraints.video.frameRate = {\n            ideal: publisherProperties.frameRate\n          };\n        }\n      } // CASE 4: deviceId or screen sharing\n\n\n      _this.configureDeviceIdOrScreensharing(myConstraints, publisherProperties, resolve, reject);\n\n      return resolve(myConstraints);\n    });\n  };\n  /**\n   * @hidden\n   */\n\n\n  OpenVidu.prototype.startWs = function (onConnectSucces) {\n    var config = {\n      heartbeat: 5000,\n      ws: {\n        uri: this.wsUri + '?sessionId=' + this.session.sessionId,\n        onconnected: onConnectSucces,\n        ondisconnect: this.disconnectCallback.bind(this),\n        onreconnecting: this.reconnectingCallback.bind(this),\n        onreconnected: this.reconnectedCallback.bind(this),\n        ismasternodecrashed: this.isMasterNodeCrashed.bind(this)\n      },\n      rpc: {\n        requestTimeout: 10000,\n        heartbeatRequestTimeout: 5000,\n        participantJoined: this.session.onParticipantJoined.bind(this.session),\n        participantPublished: this.session.onParticipantPublished.bind(this.session),\n        participantUnpublished: this.session.onParticipantUnpublished.bind(this.session),\n        participantLeft: this.session.onParticipantLeft.bind(this.session),\n        participantEvicted: this.session.onParticipantEvicted.bind(this.session),\n        recordingStarted: this.session.onRecordingStarted.bind(this.session),\n        recordingStopped: this.session.onRecordingStopped.bind(this.session),\n        sendMessage: this.session.onNewMessage.bind(this.session),\n        streamPropertyChanged: this.session.onStreamPropertyChanged.bind(this.session),\n        connectionPropertyChanged: this.session.onConnectionPropertyChanged.bind(this.session),\n        networkQualityLevelChanged: this.session.onNetworkQualityLevelChangedChanged.bind(this.session),\n        filterEventDispatched: this.session.onFilterEventDispatched.bind(this.session),\n        iceCandidate: this.session.recvIceCandidate.bind(this.session),\n        mediaError: this.session.onMediaError.bind(this.session),\n        masterNodeCrashedNotification: this.onMasterNodeCrashedNotification.bind(this),\n        forciblyReconnectSubscriber: this.session.onForciblyReconnectSubscriber.bind(this.session)\n      }\n    };\n    this.jsonRpcClient = new RpcBuilder.clients.JsonRpcClient(config);\n  };\n  /**\n   * @hidden\n   */\n\n\n  OpenVidu.prototype.onMasterNodeCrashedNotification = function (response) {\n    console.error('Master Node has crashed');\n    this.masterNodeHasCrashed = true;\n    this.session.onLostConnection(\"nodeCrashed\");\n    this.jsonRpcClient.close(4103, \"Master Node has crashed\");\n  };\n  /**\n   * @hidden\n   */\n\n\n  OpenVidu.prototype.getWsReadyState = function () {\n    return this.jsonRpcClient.getReadyState();\n  };\n  /**\n   * @hidden\n   */\n\n\n  OpenVidu.prototype.closeWs = function () {\n    this.jsonRpcClient.close(4102, \"Connection closed by client\");\n  };\n  /**\n   * @hidden\n   */\n\n\n  OpenVidu.prototype.sendRequest = function (method, params, callback) {\n    if (params && params instanceof Function) {\n      callback = params;\n      params = {};\n    }\n\n    logger.debug('Sending request: {method:\"' + method + '\", params: ' + JSON.stringify(params) + '}');\n    this.jsonRpcClient.send(method, params, callback);\n  };\n  /**\n   * @hidden\n   */\n\n\n  OpenVidu.prototype.getWsUri = function () {\n    return this.wsUri;\n  };\n  /**\n   * @hidden\n   */\n\n\n  OpenVidu.prototype.getSecret = function () {\n    return this.secret;\n  };\n  /**\n   * @hidden\n   */\n\n\n  OpenVidu.prototype.getRecorder = function () {\n    return this.recorder;\n  };\n  /**\n   * @hidden\n   */\n\n\n  OpenVidu.prototype.generateAudioDeviceError = function (error, constraints) {\n    if (error.name === 'Error') {\n      // Safari OverConstrainedError has as name property 'Error' instead of 'OverConstrainedError'\n      error.name = error.constructor.name;\n    }\n\n    var errorName, errorMessage;\n\n    switch (error.name.toLowerCase()) {\n      case 'notfounderror':\n        errorName = OpenViduError_1.OpenViduErrorName.INPUT_AUDIO_DEVICE_NOT_FOUND;\n        errorMessage = error.toString();\n        return new OpenViduError_1.OpenViduError(errorName, errorMessage);\n\n      case 'notallowederror':\n        errorName = OpenViduError_1.OpenViduErrorName.DEVICE_ACCESS_DENIED;\n        errorMessage = error.toString();\n        return new OpenViduError_1.OpenViduError(errorName, errorMessage);\n\n      case 'overconstrainederror':\n        if (error.constraint.toLowerCase() === 'deviceid') {\n          errorName = OpenViduError_1.OpenViduErrorName.INPUT_AUDIO_DEVICE_NOT_FOUND;\n          errorMessage = \"Audio input device with deviceId '\" + constraints.audio.deviceId.exact + \"' not found\";\n        } else {\n          errorName = OpenViduError_1.OpenViduErrorName.PUBLISHER_PROPERTIES_ERROR;\n          errorMessage = \"Audio input device doesn't support the value passed for constraint '\" + error.constraint + \"'\";\n        }\n\n        return new OpenViduError_1.OpenViduError(errorName, errorMessage);\n\n      case 'notreadableerror':\n        errorName = OpenViduError_1.OpenViduErrorName.DEVICE_ALREADY_IN_USE;\n        errorMessage = error.toString();\n        return new OpenViduError_1.OpenViduError(errorName, errorMessage);\n\n      default:\n        return new OpenViduError_1.OpenViduError(OpenViduError_1.OpenViduErrorName.INPUT_AUDIO_DEVICE_GENERIC_ERROR, error.toString());\n    }\n  };\n  /**\n   * @hidden\n   */\n\n\n  OpenVidu.prototype.addAlreadyProvidedTracks = function (myConstraints, mediaStream, stream) {\n    if (!!myConstraints.videoTrack) {\n      mediaStream.addTrack(myConstraints.videoTrack);\n\n      if (!!stream) {\n        if (!!myConstraints.constraints.video) {\n          stream.lastVideoTrackConstraints = myConstraints.constraints.video;\n        } else {\n          stream.lastVideoTrackConstraints = myConstraints.videoTrack.getConstraints();\n        }\n      }\n    }\n\n    if (!!myConstraints.audioTrack) {\n      mediaStream.addTrack(myConstraints.audioTrack);\n    }\n\n    return mediaStream;\n  };\n  /**\n   * @hidden\n   */\n\n\n  OpenVidu.prototype.configureDeviceIdOrScreensharing = function (myConstraints, publisherProperties, resolve, reject) {\n    var _this = this;\n\n    var audioSource = publisherProperties.audioSource;\n    var videoSource = publisherProperties.videoSource;\n\n    if (typeof audioSource === 'string') {\n      myConstraints.constraints.audio = {\n        deviceId: {\n          exact: audioSource\n        }\n      };\n    }\n\n    if (typeof videoSource === 'string') {\n      if (!this.isScreenShare(videoSource)) {\n        this.setVideoSource(myConstraints, videoSource);\n      } else {\n        // Screen sharing\n        if (!this.checkScreenSharingCapabilities()) {\n          var error = new OpenViduError_1.OpenViduError(OpenViduError_1.OpenViduErrorName.SCREEN_SHARING_NOT_SUPPORTED, 'You can only screen share in desktop Chrome, Firefox, Opera, Safari (>=13.0), Edge (>= 80) or Electron. Detected client: ' + platform.getName() + ' ' + platform.getVersion());\n          logger.error(error);\n          return reject(error);\n        } else {\n          if (platform.isElectron()) {\n            var prefix = \"screen:\";\n            var videoSourceString = videoSource;\n            var electronScreenId = videoSourceString.substr(videoSourceString.indexOf(prefix) + prefix.length);\n            myConstraints.constraints.video = {\n              mandatory: {\n                chromeMediaSource: 'desktop',\n                chromeMediaSourceId: electronScreenId\n              }\n            };\n            return resolve(myConstraints);\n          } else {\n            if (!!this.advancedConfiguration.screenShareChromeExtension && !(platform.isFirefoxBrowser() || platform.isFirefoxMobileBrowser()) && !navigator.mediaDevices['getDisplayMedia']) {\n              // Custom screen sharing extension for Chrome (and Opera) and no support for MediaDevices.getDisplayMedia()\n              screenSharing.getScreenConstraints(function (error, screenConstraints) {\n                if (!!error || !!screenConstraints.mandatory && screenConstraints.mandatory.chromeMediaSource === 'screen') {\n                  if (error === 'permission-denied' || error === 'PermissionDeniedError') {\n                    var error_1 = new OpenViduError_1.OpenViduError(OpenViduError_1.OpenViduErrorName.SCREEN_CAPTURE_DENIED, 'You must allow access to one window of your desktop');\n                    logger.error(error_1);\n                    return reject(error_1);\n                  } else {\n                    var extensionId = _this.advancedConfiguration.screenShareChromeExtension.split('/').pop().trim();\n\n                    screenSharing.getChromeExtensionStatus(extensionId, function (status) {\n                      if (status === 'installed-disabled') {\n                        var error_2 = new OpenViduError_1.OpenViduError(OpenViduError_1.OpenViduErrorName.SCREEN_EXTENSION_DISABLED, 'You must enable the screen extension');\n                        logger.error(error_2);\n                        return reject(error_2);\n                      }\n\n                      if (status === 'not-installed') {\n                        var error_3 = new OpenViduError_1.OpenViduError(OpenViduError_1.OpenViduErrorName.SCREEN_EXTENSION_NOT_INSTALLED, _this.advancedConfiguration.screenShareChromeExtension);\n                        logger.error(error_3);\n                        return reject(error_3);\n                      }\n                    });\n                    return;\n                  }\n                } else {\n                  myConstraints.constraints.video = screenConstraints;\n                  return resolve(myConstraints);\n                }\n              });\n              return;\n            } else {\n              if (navigator.mediaDevices['getDisplayMedia']) {\n                // getDisplayMedia support (Chrome >= 72, Firefox >= 66, Safari >= 13)\n                return resolve(myConstraints);\n              } else {\n                // Default screen sharing extension for Chrome/Opera, or is Firefox < 66\n                var firefoxString = platform.isFirefoxBrowser() || platform.isFirefoxMobileBrowser() ? publisherProperties.videoSource : undefined;\n                screenSharingAuto.getScreenId(firefoxString, function (error, sourceId, screenConstraints) {\n                  if (!!error) {\n                    if (error === 'not-installed') {\n                      var extensionUrl = !!_this.advancedConfiguration.screenShareChromeExtension ? _this.advancedConfiguration.screenShareChromeExtension : 'https://chrome.google.com/webstore/detail/openvidu-screensharing/lfcgfepafnobdloecchnfaclibenjold';\n                      var err = new OpenViduError_1.OpenViduError(OpenViduError_1.OpenViduErrorName.SCREEN_EXTENSION_NOT_INSTALLED, extensionUrl);\n                      logger.error(err);\n                      return reject(err);\n                    } else if (error === 'installed-disabled') {\n                      var err = new OpenViduError_1.OpenViduError(OpenViduError_1.OpenViduErrorName.SCREEN_EXTENSION_DISABLED, 'You must enable the screen extension');\n                      logger.error(err);\n                      return reject(err);\n                    } else if (error === 'permission-denied') {\n                      var err = new OpenViduError_1.OpenViduError(OpenViduError_1.OpenViduErrorName.SCREEN_CAPTURE_DENIED, 'You must allow access to one window of your desktop');\n                      logger.error(err);\n                      return reject(err);\n                    } else {\n                      var err = new OpenViduError_1.OpenViduError(OpenViduError_1.OpenViduErrorName.GENERIC_ERROR, 'Unknown error when accessing screen share');\n                      logger.error(err);\n                      logger.error(error);\n                      return reject(err);\n                    }\n                  } else {\n                    myConstraints.constraints.video = screenConstraints.video;\n                    return resolve(myConstraints);\n                  }\n                });\n                return;\n              }\n            }\n          }\n        }\n      }\n    }\n  };\n  /**\n   * @hidden\n   */\n\n\n  OpenVidu.prototype.setVideoSource = function (myConstraints, videoSource) {\n    if (!myConstraints.constraints.video) {\n      myConstraints.constraints.video = {};\n    }\n\n    myConstraints.constraints.video['deviceId'] = {\n      exact: videoSource\n    };\n  };\n  /* Private methods */\n\n\n  OpenVidu.prototype.disconnectCallback = function () {\n    logger.warn('Websocket connection lost');\n\n    if (this.isRoomAvailable()) {\n      this.session.onLostConnection('networkDisconnect');\n    } else {\n      alert('Connection error. Please reload page.');\n    }\n  };\n\n  OpenVidu.prototype.reconnectingCallback = function () {\n    logger.warn('Websocket connection lost (reconnecting)');\n\n    if (!this.isRoomAvailable()) {\n      alert('Connection error. Please reload page.');\n    } else {\n      this.session.emitEvent('reconnecting', []);\n    }\n  };\n\n  OpenVidu.prototype.reconnectWebsocketThroughRpcConnectMethod = function (rpcSessionId) {\n    var _this = this; // This RPC method allows checking:\n    // Single Master: if success, connection recovered\n    //                if error, no Master Node crashed and life will be -1. onLostConnection with reason networkDisconnect will be triggered\n    // Multi Master: if success, connection recovered\n    //               if error and Master Node crashed notification was already received, nothing must be done\n    //               if error and Master Node NOT crashed, sessionStatus method must be sent:\n    //                 if life is equal, networkDisconnect\n    //                 if life is greater, nodeCrashed\n\n\n    this.sendRequest('connect', {\n      sessionId: rpcSessionId,\n      reconnect: true\n    }, function (error, response) {\n      if (!!error) {\n        if (_this.isMasterNodeCrashed()) {\n          logger.warn('Master Node has crashed!');\n        } else {\n          logger.error(error);\n\n          var notifyLostConnection_1 = function (reason, errorMsg) {\n            logger.warn(errorMsg);\n\n            _this.session.onLostConnection(reason);\n\n            _this.jsonRpcClient.close(4101, \"Reconnection fault: \" + errorMsg);\n          };\n\n          var rpcSessionStatus = function () {\n            if (_this.life === -1) {\n              // Single Master\n              notifyLostConnection_1('networkDisconnect', 'WS successfully reconnected but the user was already evicted due to timeout');\n            } else {\n              // Multi Master\n              // This RPC method is only required to find out the reason of the disconnection:\n              // whether the client lost its network connection or a Master Node crashed\n              _this.sendRequest('sessionStatus', {\n                sessionId: _this.session.sessionId\n              }, function (error, response) {\n                if (error != null) {\n                  console.error('Error checking session status', error);\n                } else {\n                  if (_this.life === response.life) {\n                    // If the life stored in the client matches the life stored in the server, it means that the client lost its network connection\n                    notifyLostConnection_1('networkDisconnect', 'WS successfully reconnected but the user was already evicted due to timeout');\n                  } else {\n                    // If the life stored in the client is below the life stored in the server, it means that the Master Node has crashed\n                    notifyLostConnection_1('nodeCrashed', 'WS successfully reconnected to OpenVidu Server but your Master Node crashed');\n                  }\n                }\n              });\n            }\n          };\n\n          if (error.code === 40007 && error.message === 'reconnection error') {\n            // Kurento error: invalid RPC sessionId. This means that the kurento-jsonrpc-server of openvidu-server where kurento-jsonrpc-client\n            // is trying to reconnect does not know about this sessionId. This can mean two things: \n            // 1) openvidu-browser managed to reconnect after a while, but openvidu-server already evicted the user for not receiving ping.\n            // 2) openvidu-server process is a different one because of a node crash.\n            // Send a \"sessionStatus\" method to check the reason\n            console.error('Invalid RPC sessionId. Client network disconnection or Master Node crash');\n            rpcSessionStatus();\n          } else {\n            rpcSessionStatus();\n          }\n        }\n      } else {\n        _this.jsonRpcClient.resetPing();\n\n        _this.session.onRecoveredConnection();\n      }\n    });\n  };\n\n  OpenVidu.prototype.reconnectedCallback = function () {\n    logger.warn('Websocket reconnected');\n\n    if (this.isRoomAvailable()) {\n      if (!!this.session.connection) {\n        this.reconnectWebsocketThroughRpcConnectMethod(this.session.connection.rpcSessionId);\n      } else {\n        logger.warn('There was no previous connection when running reconnection callback'); // Make Session object dispatch 'sessionDisconnected' event\n\n        var sessionDisconnectEvent = new SessionDisconnectedEvent_1.SessionDisconnectedEvent(this.session, 'networkDisconnect');\n        this.session.ee.emitEvent('sessionDisconnected', [sessionDisconnectEvent]);\n        sessionDisconnectEvent.callDefaultBehavior();\n      }\n    } else {\n      alert('Connection error. Please reload page.');\n    }\n  };\n\n  OpenVidu.prototype.isMasterNodeCrashed = function () {\n    return this.masterNodeHasCrashed;\n  };\n\n  OpenVidu.prototype.isRoomAvailable = function () {\n    if (this.session !== undefined && this.session instanceof Session_1.Session) {\n      return true;\n    } else {\n      logger.warn('Session instance not found');\n      return false;\n    }\n  };\n\n  OpenVidu.prototype.isScreenShare = function (videoSource) {\n    return videoSource === 'screen' || videoSource === 'window' || platform.isElectron() && videoSource.startsWith('screen:');\n  };\n\n  return OpenVidu;\n}();\n\nexports.OpenVidu = OpenVidu;","map":{"version":3,"mappings":"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","names":["packageJson","require","logger","OpenViduLogger_1","getInstance","platform","OpenViduLoggerConfiguration_1","disabled","EventEmitter","Platform_1","libraryVersion","version","info","getDescription","isMobileDevice","isReactNative","onOrientationChanged","_this","publishers","forEach","publisher","stream","isLocalStreamPublished","hasVideo","sendNewVideoDimensionsIfRequired","OpenVidu","session","Session_1","targetElement","param2","param3","properties","audioSource","undefined","frameRate","MediaStreamTrack","videoSource","insertMode","VideoInsertMode_1","APPEND","mirror","publishAudio","publishVideo","resolution","videoSimulcast","filter","Publisher_1","completionHandler","initialize","then","emitEvent","catch","error","push","Promise","resolve","reject","callback","initPublisher","LocalRecorder_1","isIPhoneOrIPad","isIOSWithSafari","isIonicIos","isChromeMobileBrowser","isEdgeMobileBrowser","isOperaMobileBrowser","isFirefoxMobileBrowser","isChromeBrowser","isFirefoxBrowser","isOperaBrowser","isEdgeBrowser","isSafariBrowser","isAndroidBrowser","isElectron","isSamsungBrowser","canScreenShare","navigator","mediaDevices","enumerateDevices","deviceInfos","devices","isIonicAndroid","cordova","plugins","_a","EnumerateDevicesPlugin","getEnumerateDevices","pluginDevices","pluginAudioDevices","videoDevices","audioDevices","device","kind","deviceInfo","index","label","deviceId","defaultMatch","d","includes","wiredMatch","wirelessMatch","options","askForAudioStreamOnly","previousMediaStream","constraints","definedAudioConstraint","audio","constraintsAux","video","getUserMedia","addTrack","audioOnlyStream","getAudioTracks","track","stop","getVideoTracks","generateAudioDeviceError","generateMediaConstraints","myConstraints","videoTrack","audioTrack","_b","addAlreadyProvidedTracks","MediaStream","mustAskForAudioTrackLater_1","startsWith","mediaStream","errorName","OpenViduError_1","SCREEN_CAPTURE_DENIED","errorMessage","toString","DEVICE_ACCESS_DENIED","enableProdMode","configuration","advancedConfiguration","handler","window","addEventListener","reason","WAIT_INTERVAL","MAX_ATTEMPTS","attempts","oldWidth","videoDimensions","width","oldHeight","height","repeatUntilChangeOrMaxAttempts","setInterval","clearTimeout","getVideoDimensions","newDimensions","sendVideoDimensionsChangedEvent","newWidth","newHeight","sendRequest","streamId","property","newValue","JSON","stringify","response","StreamPropertyChangedEvent_1","sendVideoData","publisherProperties","NO_INPUT_SOURCE_SET","ideal","widthAndHeight","toLowerCase","split","idealWidth","Number","idealHeight","configureDeviceIdOrScreensharing","onConnectSucces","config","heartbeat","ws","uri","wsUri","sessionId","onconnected","ondisconnect","disconnectCallback","bind","onreconnecting","reconnectingCallback","onreconnected","reconnectedCallback","ismasternodecrashed","isMasterNodeCrashed","rpc","requestTimeout","heartbeatRequestTimeout","participantJoined","onParticipantJoined","participantPublished","onParticipantPublished","participantUnpublished","onParticipantUnpublished","participantLeft","onParticipantLeft","participantEvicted","onParticipantEvicted","recordingStarted","onRecordingStarted","recordingStopped","onRecordingStopped","sendMessage","onNewMessage","streamPropertyChanged","onStreamPropertyChanged","connectionPropertyChanged","onConnectionPropertyChanged","networkQualityLevelChanged","onNetworkQualityLevelChangedChanged","filterEventDispatched","onFilterEventDispatched","iceCandidate","recvIceCandidate","mediaError","onMediaError","masterNodeCrashedNotification","onMasterNodeCrashedNotification","forciblyReconnectSubscriber","onForciblyReconnectSubscriber","jsonRpcClient","RpcBuilder","clients","JsonRpcClient","console","masterNodeHasCrashed","onLostConnection","close","getReadyState","method","params","Function","debug","send","secret","recorder","name","constructor","INPUT_AUDIO_DEVICE_NOT_FOUND","constraint","exact","PUBLISHER_PROPERTIES_ERROR","DEVICE_ALREADY_IN_USE","INPUT_AUDIO_DEVICE_GENERIC_ERROR","lastVideoTrackConstraints","getConstraints","isScreenShare","setVideoSource","checkScreenSharingCapabilities","SCREEN_SHARING_NOT_SUPPORTED","getName","getVersion","prefix","videoSourceString","electronScreenId","substr","indexOf","length","mandatory","chromeMediaSource","chromeMediaSourceId","screenShareChromeExtension","screenSharing","getScreenConstraints","screenConstraints","error_1","extensionId","pop","trim","getChromeExtensionStatus","status","error_2","SCREEN_EXTENSION_DISABLED","error_3","SCREEN_EXTENSION_NOT_INSTALLED","firefoxString","screenSharingAuto","getScreenId","sourceId","extensionUrl","err","GENERIC_ERROR","warn","isRoomAvailable","alert","rpcSessionId","reconnect","notifyLostConnection_1","errorMsg","rpcSessionStatus","life","code","message","resetPing","onRecoveredConnection","connection","reconnectWebsocketThroughRpcConnectMethod","sessionDisconnectEvent","SessionDisconnectedEvent_1","ee","callDefaultBehavior","exports"],"sources":["C:\\SSAFY\\2nd semester\\S07P12D106\\front\\node_modules\\openvidu-browser\\src\\OpenVidu\\OpenVidu.ts"],"sourcesContent":["/*\n * (C) Copyright 2017-2022 OpenVidu (https://openvidu.io)\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n *\n */\n\nimport { LocalRecorder } from './LocalRecorder';\nimport { Publisher } from './Publisher';\nimport { Session } from './Session';\nimport { Stream } from './Stream';\nimport { SessionDisconnectedEvent } from '../OpenViduInternal/Events/SessionDisconnectedEvent';\nimport { StreamPropertyChangedEvent } from '../OpenViduInternal/Events/StreamPropertyChangedEvent';\nimport { Device } from '../OpenViduInternal/Interfaces/Public/Device';\nimport { OpenViduAdvancedConfiguration } from '../OpenViduInternal/Interfaces/Public/OpenViduAdvancedConfiguration';\nimport { PublisherProperties } from '../OpenViduInternal/Interfaces/Public/PublisherProperties';\nimport { CustomMediaStreamConstraints } from '../OpenViduInternal/Interfaces/Private/CustomMediaStreamConstraints';\nimport { OpenViduError, OpenViduErrorName } from '../OpenViduInternal/Enums/OpenViduError';\nimport { VideoInsertMode } from '../OpenViduInternal/Enums/VideoInsertMode';\nimport { OpenViduLogger } from '../OpenViduInternal/Logger/OpenViduLogger';\nimport { PlatformUtils } from '../OpenViduInternal/Utils/Platform';\n\nimport * as screenSharingAuto from '../OpenViduInternal/ScreenSharing/Screen-Capturing-Auto';\nimport * as screenSharing from '../OpenViduInternal/ScreenSharing/Screen-Capturing';\nimport { OpenViduLoggerConfiguration } from \"../OpenViduInternal/Logger/OpenViduLoggerConfiguration\";\n/**\n * @hidden\n */\nimport EventEmitter = require('wolfy87-eventemitter');\n/**\n * @hidden\n */\nimport RpcBuilder = require('../OpenViduInternal/KurentoUtils/kurento-jsonrpc');\n\n/**\n * @hidden\n */\nconst packageJson = require('../../package.json');\n/**\n * @hidden\n */\ndeclare var cordova: any;\n/**\n * @hidden\n */\nconst logger: OpenViduLogger = OpenViduLogger.getInstance();\n\n/**\n * @hidden\n */\nlet platform: PlatformUtils;\n\n/**\n * Entrypoint of OpenVidu Browser library.\n * Use it to initialize objects of type [[Session]], [[Publisher]] and [[LocalRecorder]]\n */\nexport class OpenVidu {\n\n  private jsonRpcClient: any;\n  private masterNodeHasCrashed = false;\n\n  /**\n   * @hidden\n   */\n  session: Session;\n  /**\n   * @hidden\n   */\n  publishers: Publisher[] = [];\n  /**\n   * @hidden\n   */\n  wsUri: string;\n  /**\n   * @hidden\n   */\n  httpUri: string;\n  /**\n   * @hidden\n   */\n  secret = '';\n  /**\n   * @hidden\n   */\n  recorder = false;\n  /**\n   * @hidden\n   */\n  iceServers: RTCIceServer[];\n  /**\n   * @hidden\n   */\n  role: string;\n  /**\n   * @hidden\n   */\n  finalUserId: string;\n  /**\n   * @hidden\n   */\n  mediaServer: string;\n  /**\n   * @hidden\n   */\n  videoSimulcast: boolean;\n  /**\n   * @hidden\n   */\n  life: number = -1;\n  /**\n   * @hidden\n   */\n  advancedConfiguration: OpenViduAdvancedConfiguration = {};\n  /**\n   * @hidden\n   */\n  webrtcStatsInterval: number = -1;\n  /**\n   * @hidden\n   */\n  sendBrowserLogs: OpenViduLoggerConfiguration = OpenViduLoggerConfiguration.disabled;\n  /**\n   * @hidden\n   */\n  isAtLeastPro: boolean = false;\n  /**\n   * @hidden\n   */\n  isEnterprise: boolean = false;\n  /**\n   * @hidden\n   */\n  libraryVersion: string;\n  /**\n   * @hidden\n   */\n  ee = new EventEmitter()\n\n  constructor() {\n    platform = PlatformUtils.getInstance();\n    this.libraryVersion = packageJson.version;\n    logger.info(\"OpenVidu initialized\");\n    logger.info('Platform detected: ' + platform.getDescription());\n    logger.info('openvidu-browser version: ' + this.libraryVersion);\n\n    if (platform.isMobileDevice() || platform.isReactNative()) {\n      // Listen to orientationchange only on mobile devices\n      this.onOrientationChanged(() => {\n        this.publishers.forEach(publisher => {\n          if (publisher.stream.isLocalStreamPublished && !!publisher.stream && !!publisher.stream.hasVideo) {\n            this.sendNewVideoDimensionsIfRequired(publisher, 'deviceRotated', 75, 10);\n          }\n        });\n      });\n    }\n  }\n\n  /**\n   * Returns new session\n   */\n  initSession(): Session {\n    this.session = new Session(this);\n    return this.session;\n  }\n\n\n  initPublisher(targetElement: string | HTMLElement): Publisher;\n  initPublisher(targetElement: string | HTMLElement, properties: PublisherProperties): Publisher;\n  initPublisher(targetElement: string | HTMLElement, completionHandler: (error: Error | undefined) => void): Publisher;\n  initPublisher(targetElement: string | HTMLElement, properties: PublisherProperties, completionHandler: (error: Error | undefined) => void): Publisher;\n\n  /**\n   * Returns a new publisher\n   *\n   * #### Events dispatched\n   *\n   * The [[Publisher]] object will dispatch an `accessDialogOpened` event, only if the pop-up shown by the browser to request permissions for the camera is opened. You can use this event to alert the user about granting permissions\n   * for your website. An `accessDialogClosed` event will also be dispatched after user clicks on \"Allow\" or \"Block\" in the pop-up.\n   *\n   * The [[Publisher]] object will dispatch an `accessAllowed` or `accessDenied` event once it has been granted access to the requested input devices or not.\n   *\n   * The [[Publisher]] object will dispatch a `videoElementCreated` event once a HTML video element has been added to DOM (only if you\n   * [let OpenVidu take care of the video players](/en/stable/cheatsheet/manage-videos/#let-openvidu-take-care-of-the-video-players)). See [[VideoElementEvent]] to learn more.\n   *\n   * The [[Publisher]] object will dispatch a `streamPlaying` event once the local streams starts playing. See [[StreamManagerEvent]] to learn more.\n   *\n   * @param targetElement  HTML DOM element (or its `id` attribute) in which the video element of the Publisher will be inserted (see [[PublisherProperties.insertMode]]). If *null* or *undefined* no default video will be created for this Publisher.\n   * You can always call method [[Publisher.addVideoElement]] or [[Publisher.createVideoElement]] to manage the video elements on your own (see [Manage video players](/en/stable/cheatsheet/manage-videos) section)\n   * @param completionHandler `error` parameter is null if `initPublisher` succeeds, and is defined if it fails.\n   *                          `completionHandler` function is called before the Publisher dispatches an `accessAllowed` or an `accessDenied` event\n   */\n  initPublisher(targetElement: string | HTMLElement, param2?, param3?): Publisher {\n\n    let properties: PublisherProperties;\n\n    if (!!param2 && (typeof param2 !== 'function')) {\n\n      // Matches 'initPublisher(targetElement, properties)' or 'initPublisher(targetElement, properties, completionHandler)'\n\n      properties = (<PublisherProperties>param2);\n\n      properties = {\n        audioSource: (typeof properties.audioSource !== 'undefined') ? properties.audioSource : undefined,\n        frameRate: (typeof MediaStreamTrack !== 'undefined' && properties.videoSource instanceof MediaStreamTrack) ? undefined : ((typeof properties.frameRate !== 'undefined') ? properties.frameRate : undefined),\n        insertMode: (typeof properties.insertMode !== 'undefined') ? ((typeof properties.insertMode === 'string') ? VideoInsertMode[properties.insertMode] : properties.insertMode) : VideoInsertMode.APPEND,\n        mirror: (typeof properties.mirror !== 'undefined') ? properties.mirror : true,\n        publishAudio: (typeof properties.publishAudio !== 'undefined') ? properties.publishAudio : true,\n        publishVideo: (typeof properties.publishVideo !== 'undefined') ? properties.publishVideo : true,\n        resolution: (typeof MediaStreamTrack !== 'undefined' && properties.videoSource instanceof MediaStreamTrack) ? undefined : ((typeof properties.resolution !== 'undefined') ? properties.resolution : '640x480'),\n        videoSource: (typeof properties.videoSource !== 'undefined') ? properties.videoSource : undefined,\n        videoSimulcast: properties.videoSimulcast,\n        filter: properties.filter\n      };\n    } else {\n\n      // Matches 'initPublisher(targetElement)' or 'initPublisher(targetElement, completionHandler)'\n\n      properties = {\n        insertMode: VideoInsertMode.APPEND,\n        mirror: true,\n        publishAudio: true,\n        publishVideo: true,\n        resolution: '640x480'\n      };\n    }\n\n    const publisher: Publisher = new Publisher(targetElement, properties, this);\n\n    let completionHandler: (error: Error | undefined) => void;\n    if (!!param2 && (typeof param2 === 'function')) {\n      completionHandler = param2;\n    } else if (!!param3) {\n      completionHandler = param3;\n    }\n\n    publisher.initialize()\n      .then(() => {\n        if (completionHandler !== undefined) {\n          completionHandler(undefined);\n        }\n        publisher.emitEvent('accessAllowed', []);\n      }).catch((error) => {\n        if (completionHandler !== undefined) {\n          completionHandler(error);\n        }\n        publisher.emitEvent('accessDenied', [error]);\n      });\n\n    this.publishers.push(publisher);\n    return publisher;\n  }\n\n\n  /**\n   * Promisified version of [[OpenVidu.initPublisher]]\n   *\n   * > WARNING: events `accessDialogOpened` and `accessDialogClosed` will not be dispatched if using this method instead of [[OpenVidu.initPublisher]]\n   */\n  initPublisherAsync(targetElement: string | HTMLElement): Promise<Publisher>;\n  initPublisherAsync(targetElement: string | HTMLElement, properties: PublisherProperties): Promise<Publisher>;\n\n  initPublisherAsync(targetElement: string | HTMLElement, properties?: PublisherProperties): Promise<Publisher> {\n    return new Promise<Publisher>((resolve, reject) => {\n\n      let publisher: Publisher;\n\n      const callback = (error: Error) => {\n        if (!!error) {\n          return reject(error);\n        } else {\n          return resolve(publisher);\n        }\n      };\n\n      if (!!properties) {\n        publisher = this.initPublisher(targetElement, properties, callback);\n      } else {\n        publisher = this.initPublisher(targetElement, callback);\n      }\n    });\n  }\n\n\n  /**\n   * Returns a new local recorder for recording streams straight away from the browser\n   * @param stream  Stream to record\n   */\n  initLocalRecorder(stream: Stream): LocalRecorder {\n    return new LocalRecorder(stream);\n  }\n\n\n  /**\n   * Checks if the browser supports OpenVidu\n   * @returns 1 if the browser supports OpenVidu, 0 otherwise\n   */\n  checkSystemRequirements(): number {\n\n    if (platform.isIPhoneOrIPad()) {\n      if (platform.isIOSWithSafari() || platform.isIonicIos() ||\n        platform.isChromeMobileBrowser() || platform.isEdgeMobileBrowser() || platform.isOperaMobileBrowser() || platform.isFirefoxMobileBrowser()) {\n        return 1;\n      }\n      return 0;\n    }\n\n    // Accept: Chrome (desktop and Android), Firefox (desktop and Android), Opera (desktop and Android),\n    // Safari (OSX and iOS), Edge Chromium (>= 80), Ionic (Android and iOS), Samsung Internet Browser (Android)\n    if (platform.isChromeBrowser() || platform.isChromeMobileBrowser() ||\n      platform.isFirefoxBrowser() || platform.isFirefoxMobileBrowser() || platform.isOperaBrowser() ||\n      platform.isOperaMobileBrowser() || platform.isEdgeBrowser() || platform.isEdgeMobileBrowser() ||\n      platform.isSafariBrowser() || platform.isAndroidBrowser() || platform.isElectron() || platform.isSamsungBrowser()\n    ) {\n      return 1;\n    }\n    // Reject iPhones and iPads if not Safari ('Safari' also covers Ionic for iOS)\n    // Reject others browsers not mentioned above\n    return 0;\n\n  }\n\n  /**\n   * Checks if the browser supports screen-sharing. Desktop Chrome, Firefox and Opera support screen-sharing\n   * @returns 1 if the browser supports screen-sharing, 0 otherwise\n   */\n  checkScreenSharingCapabilities(): boolean {\n    return platform.canScreenShare();\n  }\n\n\n  /**\n   * Collects information about the media input devices available on the system. You can pass property `deviceId` of a [[Device]] object as value of `audioSource` or `videoSource` properties in [[initPublisher]] method\n   */\n  getDevices(): Promise<Device[]> {\n    return new Promise<Device[]>((resolve, reject) => {\n      navigator.mediaDevices.enumerateDevices().then((deviceInfos) => {\n        const devices: Device[] = [];\n\n        // Ionic Android  devices\n        if (platform.isIonicAndroid() && typeof cordova != \"undefined\" && cordova?.plugins?.EnumerateDevicesPlugin) {\n          cordova.plugins.EnumerateDevicesPlugin.getEnumerateDevices().then((pluginDevices: Device[]) => {\n            let pluginAudioDevices: Device[] = [];\n            let videoDevices: Device[] = [];\n            let audioDevices: Device[] = [];\n            pluginAudioDevices = pluginDevices.filter((device: Device) => device.kind === 'audioinput');\n            videoDevices = deviceInfos.filter((device: Device) => device.kind === 'videoinput');\n            audioDevices = deviceInfos.filter((device: Device) => device.kind === 'audioinput');\n            videoDevices.forEach((deviceInfo, index) => {\n              if (!deviceInfo.label) {\n                let label = \"\";\n                if (index === 0) {\n                  label = \"Front Camera\";\n                } else if (index === 1) {\n                  label = \"Back Camera\";\n                } else {\n                  label = \"Unknown Camera\";\n                }\n                devices.push({\n                  kind: deviceInfo.kind,\n                  deviceId: deviceInfo.deviceId,\n                  label: label\n                });\n\n              } else {\n                devices.push({\n                  kind: deviceInfo.kind,\n                  deviceId: deviceInfo.deviceId,\n                  label: deviceInfo.label\n                });\n              }\n            });\n            audioDevices.forEach((deviceInfo, index) => {\n              if (!deviceInfo.label) {\n                let label = \"\";\n                switch (index) {\n                  case 0: // Default Microphone\n                    label = 'Default';\n                    break;\n                  case 1: // Microphone + Speakerphone\n                    const defaultMatch = pluginAudioDevices.filter((d) => d.label.includes('Built'))[0];\n                    label = defaultMatch ? defaultMatch.label : 'Built-in Microphone';\n                    break;\n                  case 2: // Headset Microphone\n                    const wiredMatch = pluginAudioDevices.filter((d) => d.label.includes('Wired'))[0];\n                    if (wiredMatch) {\n                      label = wiredMatch.label;\n                    } else {\n                      label = 'Headset earpiece';\n                    }\n                    break;\n                  case 3:\n                    const wirelessMatch = pluginAudioDevices.filter((d) => d.label.includes('Bluetooth'))[0];\n                    label = wirelessMatch ? wirelessMatch.label : 'Wireless';\n                    break;\n                  default:\n                    label = \"Unknown Microphone\";\n                    break;\n                }\n                devices.push({\n                  kind: deviceInfo.kind,\n                  deviceId: deviceInfo.deviceId,\n                  label: label\n                });\n\n              } else {\n                devices.push({\n                  kind: deviceInfo.kind,\n                  deviceId: deviceInfo.deviceId,\n                  label: deviceInfo.label\n                });\n              }\n            });\n            return resolve(devices);\n          });\n        } else {\n\n          // Rest of platforms\n          deviceInfos.forEach(deviceInfo => {\n            if (deviceInfo.kind === 'audioinput' || deviceInfo.kind === 'videoinput') {\n              devices.push({\n                kind: deviceInfo.kind,\n                deviceId: deviceInfo.deviceId,\n                label: deviceInfo.label\n              });\n            }\n          });\n          return resolve(devices);\n        }\n      }).catch((error) => {\n        logger.error('Error getting devices', error);\n        return reject(error);\n      });\n    });\n  }\n\n\n\n  /**\n   * Get a MediaStream object that you can customize before calling [[initPublisher]] (pass _MediaStreamTrack_ property of the _MediaStream_ value resolved by the Promise as `audioSource` or `videoSource` properties in [[initPublisher]])\n   *\n   * Parameter `options` is the same as in [[initPublisher]] second parameter (of type [[PublisherProperties]]), but only the following properties will be applied: `audioSource`, `videoSource`, `frameRate`, `resolution`\n   *\n   * To customize the Publisher's video, the API for HTMLCanvasElement is very useful. For example, to get a black-and-white video at 10 fps and HD resolution with no sound:\n   * ```\n   * var OV = new OpenVidu();\n   * var FRAME_RATE = 10;\n   *\n   * OV.getUserMedia({\n   *    audioSource: false,\n   *    videoSource: undefined,\n   *    resolution: '1280x720',\n   *    frameRate: FRAME_RATE\n   * })\n   * .then(mediaStream => {\n   *\n   *    var videoTrack = mediaStream.getVideoTracks()[0];\n   *    var video = document.createElement('video');\n   *    video.srcObject = new MediaStream([videoTrack]);\n   *\n   *    var canvas = document.createElement('canvas');\n   *    var ctx = canvas.getContext('2d');\n   *    ctx.filter = 'grayscale(100%)';\n   *\n   *    video.addEventListener('play', () => {\n   *      var loop = () => {\n   *        if (!video.paused && !video.ended) {\n   *          ctx.drawImage(video, 0, 0, 300, 170);\n   *          setTimeout(loop, 1000/ FRAME_RATE); // Drawing at 10 fps\n   *        }\n   *      };\n   *      loop();\n   *    });\n   *    video.play();\n   *\n   *    var grayVideoTrack = canvas.captureStream(FRAME_RATE).getVideoTracks()[0];\n   *    var publisher = this.OV.initPublisher(\n   *      myHtmlTarget,\n   *      {\n   *        audioSource: false,\n   *        videoSource: grayVideoTrack\n   *      });\n   * });\n   * ```\n   */\n  getUserMedia(options: PublisherProperties): Promise<MediaStream> {\n    return new Promise<MediaStream>((resolve, reject) => {\n\n      const askForAudioStreamOnly = (previousMediaStream: MediaStream, constraints: MediaStreamConstraints) => {\n        const definedAudioConstraint = ((constraints.audio === undefined) ? true : constraints.audio);\n        const constraintsAux: MediaStreamConstraints = { audio: definedAudioConstraint, video: false };\n        navigator.mediaDevices.getUserMedia(constraintsAux)\n          .then(audioOnlyStream => {\n            previousMediaStream.addTrack(audioOnlyStream.getAudioTracks()[0]);\n            return resolve(previousMediaStream);\n          })\n          .catch(error => {\n            previousMediaStream.getAudioTracks().forEach((track) => {\n              track.stop();\n            });\n            previousMediaStream.getVideoTracks().forEach((track) => {\n              track.stop();\n            });\n            return reject(this.generateAudioDeviceError(error, constraintsAux));\n          });\n      }\n\n      this.generateMediaConstraints(options).then(myConstraints => {\n\n        if (!!myConstraints.videoTrack && !!myConstraints.audioTrack ||\n          !!myConstraints.audioTrack && myConstraints.constraints?.video === false ||\n          !!myConstraints.videoTrack && myConstraints.constraints?.audio === false) {\n\n          // No need to call getUserMedia at all. Both tracks provided, or only AUDIO track provided or only VIDEO track provided\n          return resolve(this.addAlreadyProvidedTracks(myConstraints, new MediaStream()));\n\n        } else {\n          // getUserMedia must be called. AUDIO or VIDEO are requesting a new track\n\n          // Delete already provided constraints for audio or video\n          if (!!myConstraints.videoTrack) {\n            delete myConstraints.constraints!.video;\n          }\n          if (!!myConstraints.audioTrack) {\n            delete myConstraints.constraints!.audio;\n          }\n\n          let mustAskForAudioTrackLater = false;\n          if (typeof options.videoSource === 'string') {\n            // Video is deviceId or screen sharing\n            if (options.videoSource === 'screen' ||\n              options.videoSource === 'window' ||\n              (platform.isElectron() && options.videoSource.startsWith('screen:'))) {\n              // Video is screen sharing\n              mustAskForAudioTrackLater = !myConstraints.audioTrack && (options.audioSource !== null && options.audioSource !== false);\n              if (navigator.mediaDevices['getDisplayMedia'] && !platform.isElectron()) {\n                // getDisplayMedia supported\n                navigator.mediaDevices['getDisplayMedia']({ video: true })\n                  .then(mediaStream => {\n                    this.addAlreadyProvidedTracks(myConstraints, mediaStream);\n                    if (mustAskForAudioTrackLater) {\n                      askForAudioStreamOnly(mediaStream, <MediaStreamConstraints>myConstraints.constraints);\n                      return;\n                    } else {\n                      return resolve(mediaStream);\n                    }\n                  })\n                  .catch(error => {\n                    let errorName: OpenViduErrorName = OpenViduErrorName.SCREEN_CAPTURE_DENIED;\n                    const errorMessage = error.toString();\n                    return reject(new OpenViduError(errorName, errorMessage));\n                  });\n                return;\n              } else {\n                // getDisplayMedia NOT supported. Can perform getUserMedia below with already calculated constraints\n              }\n            } else {\n              // Video is deviceId. Can perform getUserMedia below with already calculated constraints\n            }\n          }\n          // Use already calculated constraints\n          const constraintsAux = mustAskForAudioTrackLater ? { video: myConstraints.constraints!.video } : myConstraints.constraints;\n          navigator.mediaDevices.getUserMedia(constraintsAux)\n            .then(mediaStream => {\n              this.addAlreadyProvidedTracks(myConstraints, mediaStream);\n              if (mustAskForAudioTrackLater) {\n                askForAudioStreamOnly(mediaStream, <MediaStreamConstraints>myConstraints.constraints);\n                return;\n              } else {\n                return resolve(mediaStream);\n              }\n            })\n            .catch(error => {\n              let errorName: OpenViduErrorName;\n              const errorMessage = error.toString();\n              if (!(options.videoSource === 'screen')) {\n                errorName = OpenViduErrorName.DEVICE_ACCESS_DENIED;\n              } else {\n                errorName = OpenViduErrorName.SCREEN_CAPTURE_DENIED;\n              }\n              return reject(new OpenViduError(errorName, errorMessage));\n            });\n        }\n      }).catch((error: OpenViduError) => reject(error));\n    });\n  }\n\n\n  /* tslint:disable:no-empty */\n  /**\n   * Disable all logging except error level\n   */\n  enableProdMode(): void {\n    logger.enableProdMode();\n  }\n  /* tslint:enable:no-empty */\n\n\n  /**\n   * Set OpenVidu advanced configuration options. `configuration` is an object of type [[OpenViduAdvancedConfiguration]]. Call this method to override previous values at any moment.\n   */\n  setAdvancedConfiguration(configuration: OpenViduAdvancedConfiguration): void {\n    this.advancedConfiguration = configuration;\n  }\n\n\n  /* Hidden methods */\n\n  /**\n   * @hidden\n   */\n  onOrientationChanged(handler): void {\n    (<any>window).addEventListener('orientationchange', handler);\n  }\n\n  /**\n   * @hidden\n   */\n  sendNewVideoDimensionsIfRequired(publisher: Publisher, reason: string, WAIT_INTERVAL: number, MAX_ATTEMPTS: number) {\n    let attempts = 0;\n    const oldWidth = publisher.stream.videoDimensions.width;\n    const oldHeight = publisher.stream.videoDimensions.height;\n\n    const repeatUntilChangeOrMaxAttempts: NodeJS.Timeout = setInterval(() => {\n      attempts++;\n      if (attempts > MAX_ATTEMPTS) {\n        clearTimeout(repeatUntilChangeOrMaxAttempts);\n      }\n      publisher.getVideoDimensions().then(newDimensions => {\n        if (newDimensions.width !== oldWidth || newDimensions.height !== oldHeight) {\n          clearTimeout(repeatUntilChangeOrMaxAttempts);\n          this.sendVideoDimensionsChangedEvent(publisher, reason, oldWidth, oldHeight, newDimensions.width, newDimensions.height);\n        }\n      });\n    }, WAIT_INTERVAL);\n  }\n\n  /**\n   * @hidden\n   */\n  sendVideoDimensionsChangedEvent(publisher: Publisher, reason: string, oldWidth: number, oldHeight: number, newWidth: number, newHeight: number) {\n    publisher.stream.videoDimensions = {\n      width: newWidth || 0,\n      height: newHeight || 0\n    };\n    this.sendRequest(\n      'streamPropertyChanged',\n      {\n        streamId: publisher.stream.streamId,\n        property: 'videoDimensions',\n        newValue: JSON.stringify(publisher.stream.videoDimensions),\n        reason\n      },\n      (error, response) => {\n        if (error) {\n          logger.error(\"Error sending 'streamPropertyChanged' event\", error);\n        } else {\n          this.session.emitEvent('streamPropertyChanged', [new StreamPropertyChangedEvent(this.session, publisher.stream, 'videoDimensions', publisher.stream.videoDimensions, { width: oldWidth, height: oldHeight }, reason)]);\n          publisher.emitEvent('streamPropertyChanged', [new StreamPropertyChangedEvent(publisher, publisher.stream, 'videoDimensions', publisher.stream.videoDimensions, { width: oldWidth, height: oldHeight }, reason)]);\n          this.session.sendVideoData(publisher);\n        }\n      });\n  };\n\n  /**\n   * @hidden\n   */\n  generateMediaConstraints(publisherProperties: PublisherProperties): Promise<CustomMediaStreamConstraints> {\n    return new Promise<CustomMediaStreamConstraints>((resolve, reject) => {\n\n      const myConstraints: CustomMediaStreamConstraints = {\n        audioTrack: undefined,\n        videoTrack: undefined,\n        constraints: {\n          audio: undefined,\n          video: undefined\n        }\n      }\n      const audioSource = publisherProperties.audioSource;\n      const videoSource = publisherProperties.videoSource;\n\n      // CASE 1: null/false\n      if (audioSource === null || audioSource === false) {\n        // No audio track\n        myConstraints.constraints!.audio = false;\n      }\n      if (videoSource === null || videoSource === false) {\n        // No video track\n        myConstraints.constraints!.video = false;\n      }\n      if (myConstraints.constraints!.audio === false && myConstraints.constraints!.video === false) {\n        // ERROR! audioSource and videoSource cannot be both false at the same time\n        return reject(new OpenViduError(OpenViduErrorName.NO_INPUT_SOURCE_SET,\n          \"Properties 'audioSource' and 'videoSource' cannot be set to false or null at the same time\"));\n      }\n\n      // CASE 2: MediaStreamTracks\n      if (typeof MediaStreamTrack !== 'undefined' && audioSource instanceof MediaStreamTrack) {\n        // Already provided audio track\n        myConstraints.audioTrack = audioSource;\n      }\n      if (typeof MediaStreamTrack !== 'undefined' && videoSource instanceof MediaStreamTrack) {\n        // Already provided video track\n        myConstraints.videoTrack = videoSource;\n      }\n\n      // CASE 3: Default tracks\n      if (audioSource === undefined) {\n        myConstraints.constraints!.audio = true;\n      }\n      if (videoSource === undefined) {\n        myConstraints.constraints!.video = {\n          width: {\n            ideal: 640\n          },\n          height: {\n            ideal: 480\n          }\n        };\n      }\n\n      // CASE 3.5: give values to resolution and frameRate if video not null/false\n      if (videoSource !== null && videoSource !== false) {\n        if (!!publisherProperties.resolution) {\n          const widthAndHeight = publisherProperties.resolution.toLowerCase().split('x');\n          const idealWidth = Number(widthAndHeight[0]);\n          const idealHeight = Number(widthAndHeight[1]);\n          myConstraints.constraints!.video = {\n            width: {\n              ideal: idealWidth\n            },\n            height: {\n              ideal: idealHeight\n            }\n          }\n        }\n        if (!!publisherProperties.frameRate) {\n          (<MediaTrackConstraints>myConstraints.constraints!.video).frameRate = { ideal: publisherProperties.frameRate };\n        }\n      }\n\n      // CASE 4: deviceId or screen sharing\n      this.configureDeviceIdOrScreensharing(myConstraints, publisherProperties, resolve, reject);\n\n      return resolve(myConstraints);\n    });\n  }\n\n  /**\n   * @hidden\n   */\n  startWs(onConnectSucces: (error: Error) => void): void {\n    const config = {\n      heartbeat: 5000,\n      ws: {\n        uri: this.wsUri + '?sessionId=' + this.session.sessionId,\n        onconnected: onConnectSucces,\n        ondisconnect: this.disconnectCallback.bind(this),\n        onreconnecting: this.reconnectingCallback.bind(this),\n        onreconnected: this.reconnectedCallback.bind(this),\n        ismasternodecrashed: this.isMasterNodeCrashed.bind(this)\n      },\n      rpc: {\n        requestTimeout: 10000,\n        heartbeatRequestTimeout: 5000,\n        participantJoined: this.session.onParticipantJoined.bind(this.session),\n        participantPublished: this.session.onParticipantPublished.bind(this.session),\n        participantUnpublished: this.session.onParticipantUnpublished.bind(this.session),\n        participantLeft: this.session.onParticipantLeft.bind(this.session),\n        participantEvicted: this.session.onParticipantEvicted.bind(this.session),\n        recordingStarted: this.session.onRecordingStarted.bind(this.session),\n        recordingStopped: this.session.onRecordingStopped.bind(this.session),\n        sendMessage: this.session.onNewMessage.bind(this.session),\n        streamPropertyChanged: this.session.onStreamPropertyChanged.bind(this.session),\n        connectionPropertyChanged: this.session.onConnectionPropertyChanged.bind(this.session),\n        networkQualityLevelChanged: this.session.onNetworkQualityLevelChangedChanged.bind(this.session),\n        filterEventDispatched: this.session.onFilterEventDispatched.bind(this.session),\n        iceCandidate: this.session.recvIceCandidate.bind(this.session),\n        mediaError: this.session.onMediaError.bind(this.session),\n        masterNodeCrashedNotification: this.onMasterNodeCrashedNotification.bind(this),\n        forciblyReconnectSubscriber: this.session.onForciblyReconnectSubscriber.bind(this.session)\n      }\n    };\n    this.jsonRpcClient = new RpcBuilder.clients.JsonRpcClient(config);\n  }\n\n  /**\n   * @hidden\n   */\n  onMasterNodeCrashedNotification(response): void {\n    console.error('Master Node has crashed');\n    this.masterNodeHasCrashed = true;\n    this.session.onLostConnection(\"nodeCrashed\");\n    this.jsonRpcClient.close(4103, \"Master Node has crashed\");\n  }\n\n  /**\n   * @hidden\n   */\n  getWsReadyState(): number {\n    return this.jsonRpcClient.getReadyState();\n  }\n\n  /**\n   * @hidden\n   */\n  closeWs(): void {\n    this.jsonRpcClient.close(4102, \"Connection closed by client\");\n  }\n\n  /**\n   * @hidden\n   */\n  sendRequest(method: string, params: any, callback?): void {\n    if (params && params instanceof Function) {\n      callback = params;\n      params = {};\n    }\n    logger.debug('Sending request: {method:\"' + method + '\", params: ' + JSON.stringify(params) + '}');\n    this.jsonRpcClient.send(method, params, callback);\n  }\n\n  /**\n   * @hidden\n   */\n  getWsUri(): string {\n    return this.wsUri;\n  }\n\n  /**\n   * @hidden\n   */\n  getSecret(): string {\n    return this.secret;\n  }\n\n  /**\n   * @hidden\n   */\n  getRecorder(): boolean {\n    return this.recorder;\n  }\n\n  /**\n   * @hidden\n   */\n  generateAudioDeviceError(error, constraints: MediaStreamConstraints): OpenViduError {\n    if (error.name === 'Error') {\n      // Safari OverConstrainedError has as name property 'Error' instead of 'OverConstrainedError'\n      error.name = error.constructor.name;\n    }\n    let errorName, errorMessage: string;\n    switch (error.name.toLowerCase()) {\n      case 'notfounderror':\n        errorName = OpenViduErrorName.INPUT_AUDIO_DEVICE_NOT_FOUND;\n        errorMessage = error.toString();\n        return new OpenViduError(errorName, errorMessage);\n      case 'notallowederror':\n        errorName = OpenViduErrorName.DEVICE_ACCESS_DENIED;\n        errorMessage = error.toString();\n        return new OpenViduError(errorName, errorMessage);\n      case 'overconstrainederror':\n        if (error.constraint.toLowerCase() === 'deviceid') {\n          errorName = OpenViduErrorName.INPUT_AUDIO_DEVICE_NOT_FOUND;\n          errorMessage = \"Audio input device with deviceId '\" + (<ConstrainDOMStringParameters>(<MediaTrackConstraints>constraints.audio).deviceId!!).exact + \"' not found\";\n        } else {\n          errorName = OpenViduErrorName.PUBLISHER_PROPERTIES_ERROR;\n          errorMessage = \"Audio input device doesn't support the value passed for constraint '\" + error.constraint + \"'\";\n        }\n        return new OpenViduError(errorName, errorMessage);\n      case 'notreadableerror':\n        errorName = OpenViduErrorName.DEVICE_ALREADY_IN_USE;\n        errorMessage = error.toString();\n        return (new OpenViduError(errorName, errorMessage));\n      default:\n        return new OpenViduError(OpenViduErrorName.INPUT_AUDIO_DEVICE_GENERIC_ERROR, error.toString());\n    }\n  }\n\n  /**\n   * @hidden\n   */\n  addAlreadyProvidedTracks(myConstraints: CustomMediaStreamConstraints, mediaStream: MediaStream, stream?: Stream) {\n    if (!!myConstraints.videoTrack) {\n      mediaStream.addTrack(myConstraints.videoTrack);\n      if (!!stream) {\n        if (!!myConstraints.constraints.video) {\n          stream.lastVideoTrackConstraints = myConstraints.constraints.video;\n        } else {\n          stream.lastVideoTrackConstraints = myConstraints.videoTrack.getConstraints();\n        }\n      }\n    }\n    if (!!myConstraints.audioTrack) {\n      mediaStream.addTrack(myConstraints.audioTrack);\n    }\n    return mediaStream;\n  }\n\n  /**\n   * @hidden\n   */\n  protected configureDeviceIdOrScreensharing(myConstraints: CustomMediaStreamConstraints, publisherProperties: PublisherProperties, resolve, reject) {\n    const audioSource = publisherProperties.audioSource;\n    const videoSource = publisherProperties.videoSource;\n    if (typeof audioSource === 'string') {\n      myConstraints.constraints!.audio = { deviceId: { exact: audioSource } };\n    }\n\n    if (typeof videoSource === 'string') {\n\n      if (!this.isScreenShare(videoSource)) {\n        this.setVideoSource(myConstraints, videoSource);\n\n      } else {\n\n        // Screen sharing\n\n        if (!this.checkScreenSharingCapabilities()) {\n          const error = new OpenViduError(OpenViduErrorName.SCREEN_SHARING_NOT_SUPPORTED, 'You can only screen share in desktop Chrome, Firefox, Opera, Safari (>=13.0), Edge (>= 80) or Electron. Detected client: ' + platform.getName() + ' ' + platform.getVersion());\n          logger.error(error);\n          return reject(error);\n        } else {\n\n          if (platform.isElectron()) {\n            const prefix = \"screen:\";\n            const videoSourceString: string = videoSource;\n            const electronScreenId = videoSourceString.substr(videoSourceString.indexOf(prefix) + prefix.length);\n            (<any>myConstraints.constraints!.video) = {\n              mandatory: {\n                chromeMediaSource: 'desktop',\n                chromeMediaSourceId: electronScreenId\n              }\n            };\n            return resolve(myConstraints);\n\n          } else {\n\n            if (!!this.advancedConfiguration.screenShareChromeExtension && !(platform.isFirefoxBrowser() || platform.isFirefoxMobileBrowser()) && !navigator.mediaDevices['getDisplayMedia']) {\n\n              // Custom screen sharing extension for Chrome (and Opera) and no support for MediaDevices.getDisplayMedia()\n\n              screenSharing.getScreenConstraints((error, screenConstraints) => {\n                if (!!error || !!screenConstraints.mandatory && screenConstraints.mandatory.chromeMediaSource === 'screen') {\n                  if (error === 'permission-denied' || error === 'PermissionDeniedError') {\n                    const error = new OpenViduError(OpenViduErrorName.SCREEN_CAPTURE_DENIED, 'You must allow access to one window of your desktop');\n                    logger.error(error);\n                    return reject(error);\n                  } else {\n                    const extensionId = this.advancedConfiguration.screenShareChromeExtension!.split('/').pop()!!.trim();\n                    screenSharing.getChromeExtensionStatus(extensionId, status => {\n                      if (status === 'installed-disabled') {\n                        const error = new OpenViduError(OpenViduErrorName.SCREEN_EXTENSION_DISABLED, 'You must enable the screen extension');\n                        logger.error(error);\n                        return reject(error);\n                      }\n                      if (status === 'not-installed') {\n                        const error = new OpenViduError(OpenViduErrorName.SCREEN_EXTENSION_NOT_INSTALLED, (<string>this.advancedConfiguration.screenShareChromeExtension));\n                        logger.error(error);\n                        return reject(error);\n                      }\n                    });\n                    return;\n                  }\n                } else {\n                  myConstraints.constraints!.video = screenConstraints;\n                  return resolve(myConstraints);\n                }\n              });\n              return;\n            } else {\n\n              if (navigator.mediaDevices['getDisplayMedia']) {\n                // getDisplayMedia support (Chrome >= 72, Firefox >= 66, Safari >= 13)\n                return resolve(myConstraints);\n              } else {\n                // Default screen sharing extension for Chrome/Opera, or is Firefox < 66\n                const firefoxString = (platform.isFirefoxBrowser() || platform.isFirefoxMobileBrowser()) ? publisherProperties.videoSource : undefined;\n\n                screenSharingAuto.getScreenId(firefoxString, (error, sourceId, screenConstraints) => {\n                  if (!!error) {\n                    if (error === 'not-installed') {\n                      const extensionUrl = !!this.advancedConfiguration.screenShareChromeExtension ? this.advancedConfiguration.screenShareChromeExtension :\n                        'https://chrome.google.com/webstore/detail/openvidu-screensharing/lfcgfepafnobdloecchnfaclibenjold';\n                      const err = new OpenViduError(OpenViduErrorName.SCREEN_EXTENSION_NOT_INSTALLED, extensionUrl);\n                      logger.error(err);\n                      return reject(err);\n                    } else if (error === 'installed-disabled') {\n                      const err = new OpenViduError(OpenViduErrorName.SCREEN_EXTENSION_DISABLED, 'You must enable the screen extension');\n                      logger.error(err);\n                      return reject(err);\n                    } else if (error === 'permission-denied') {\n                      const err = new OpenViduError(OpenViduErrorName.SCREEN_CAPTURE_DENIED, 'You must allow access to one window of your desktop');\n                      logger.error(err);\n                      return reject(err);\n                    } else {\n                      const err = new OpenViduError(OpenViduErrorName.GENERIC_ERROR, 'Unknown error when accessing screen share');\n                      logger.error(err);\n                      logger.error(error);\n                      return reject(err);\n                    }\n                  } else {\n                    myConstraints.constraints!.video = screenConstraints.video;\n                    return resolve(myConstraints);\n                  }\n                });\n                return;\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n\n  /**\n   * @hidden\n   */\n  protected setVideoSource(myConstraints: CustomMediaStreamConstraints, videoSource: string) {\n    if (!myConstraints.constraints!.video) {\n      myConstraints.constraints!.video = {};\n    }\n    (<MediaTrackConstraints>myConstraints.constraints!.video)['deviceId'] = { exact: videoSource };\n  }\n\n\n  /* Private methods */\n\n  private disconnectCallback(): void {\n    logger.warn('Websocket connection lost');\n    if (this.isRoomAvailable()) {\n      this.session.onLostConnection('networkDisconnect');\n    } else {\n      alert('Connection error. Please reload page.');\n    }\n  }\n\n  private reconnectingCallback(): void {\n    logger.warn('Websocket connection lost (reconnecting)');\n    if (!this.isRoomAvailable()) {\n      alert('Connection error. Please reload page.');\n    } else {\n      this.session.emitEvent('reconnecting', []);\n    }\n  }\n\n  private reconnectWebsocketThroughRpcConnectMethod(rpcSessionId) {\n    // This RPC method allows checking:\n    // Single Master: if success, connection recovered\n    //                if error, no Master Node crashed and life will be -1. onLostConnection with reason networkDisconnect will be triggered\n    // Multi Master: if success, connection recovered\n    //               if error and Master Node crashed notification was already received, nothing must be done\n    //               if error and Master Node NOT crashed, sessionStatus method must be sent:\n    //                 if life is equal, networkDisconnect\n    //                 if life is greater, nodeCrashed\n    this.sendRequest('connect', { sessionId: rpcSessionId, reconnect: true }, (error, response) => {\n      if (!!error) {\n\n        if (this.isMasterNodeCrashed()) {\n\n          logger.warn('Master Node has crashed!');\n\n        } else {\n\n          logger.error(error);\n\n          const notifyLostConnection = (reason, errorMsg) => {\n            logger.warn(errorMsg);\n            this.session.onLostConnection(reason);\n            this.jsonRpcClient.close(4101, \"Reconnection fault: \" + errorMsg);\n          }\n\n          const rpcSessionStatus = () => {\n            if (this.life === -1) {\n              // Single Master\n              notifyLostConnection('networkDisconnect', 'WS successfully reconnected but the user was already evicted due to timeout');\n            } else {\n              // Multi Master\n              // This RPC method is only required to find out the reason of the disconnection:\n              // whether the client lost its network connection or a Master Node crashed\n              this.sendRequest('sessionStatus', { sessionId: this.session.sessionId }, (error, response) => {\n                if (error != null) {\n                  console.error('Error checking session status', error);\n                } else {\n                  if (this.life === response.life) {\n                    // If the life stored in the client matches the life stored in the server, it means that the client lost its network connection\n                    notifyLostConnection('networkDisconnect', 'WS successfully reconnected but the user was already evicted due to timeout');\n                  } else {\n                    // If the life stored in the client is below the life stored in the server, it means that the Master Node has crashed\n                    notifyLostConnection('nodeCrashed', 'WS successfully reconnected to OpenVidu Server but your Master Node crashed');\n                  }\n                }\n              });\n            }\n          };\n\n          if (error.code === 40007 && error.message === 'reconnection error') {\n            // Kurento error: invalid RPC sessionId. This means that the kurento-jsonrpc-server of openvidu-server where kurento-jsonrpc-client\n            // is trying to reconnect does not know about this sessionId. This can mean two things: \n            // 1) openvidu-browser managed to reconnect after a while, but openvidu-server already evicted the user for not receiving ping.\n            // 2) openvidu-server process is a different one because of a node crash.\n            // Send a \"sessionStatus\" method to check the reason\n            console.error('Invalid RPC sessionId. Client network disconnection or Master Node crash');\n            rpcSessionStatus();\n          } else {\n            rpcSessionStatus();\n          }\n\n        }\n      } else {\n        this.jsonRpcClient.resetPing();\n        this.session.onRecoveredConnection();\n      }\n    });\n  }\n\n  private reconnectedCallback(): void {\n    logger.warn('Websocket reconnected');\n    if (this.isRoomAvailable()) {\n      if (!!this.session.connection) {\n        this.reconnectWebsocketThroughRpcConnectMethod(this.session.connection.rpcSessionId);\n      } else {\n        logger.warn('There was no previous connection when running reconnection callback');\n        // Make Session object dispatch 'sessionDisconnected' event\n        const sessionDisconnectEvent = new SessionDisconnectedEvent(this.session, 'networkDisconnect');\n        this.session.ee.emitEvent('sessionDisconnected', [sessionDisconnectEvent]);\n        sessionDisconnectEvent.callDefaultBehavior();\n      }\n    } else {\n      alert('Connection error. Please reload page.');\n    }\n  }\n\n  private isMasterNodeCrashed() {\n    return this.masterNodeHasCrashed;\n  }\n\n  private isRoomAvailable(): boolean {\n    if (this.session !== undefined && this.session instanceof Session) {\n      return true;\n    } else {\n      logger.warn('Session instance not found');\n      return false;\n    }\n  }\n\n  private isScreenShare(videoSource: string) {\n    return videoSource === 'screen' ||\n      videoSource === 'window' ||\n      (platform.isElectron() && videoSource.startsWith('screen:'))\n  }\n\n}\n"]},"metadata":{},"sourceType":"script"}